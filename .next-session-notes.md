# Next Session Start Here

## IMMEDIATE PRIORITY: Fix Command Routing Bug

**Problem**: All protocol commands route to Echo handler instead of their specific handlers.

**Location**: `src/Aletheia/Protocol/Parser.agda:125-160`

**Test Case**:
```bash
# Currently fails - routes to Echo:
./build/aletheia < test_command_only.yaml

# Contents of test file:
command: "ExtractSignal"
message: "test"
```

**Expected**: Should fail with "Failed to parse command" (missing required fields)
**Actual**: Returns `success: true, echo: "test"` (routed to Echo handler)

## Debugging Approach

### Option 1: Add Debug Output
Temporarily modify parser to return the command type string:
```agda
parseCommand : Parser String  -- Change return type temporarily
parseCommand = parseCommandType <* newline
```

Test to see what string value is actually being parsed.

### Option 2: Simplify Routing
Replace if-then-else cascade with explicit parsers using `<|>`:
```agda
parseCommand : Parser Command
parseCommand =
  (string "command: \"Echo\"" *> newline *> (Echo <$> keyValue "message"))
  <|> (string "command: \"ParseDBC\"" *> newline *> (ParseDBC <$> multilineValue "yaml"))
  <|> (string "command: \"ExtractSignal\"" *> newline *> parseExtractSignalFields)
  <|> (string "command: \"InjectSignal\"" *> newline *> parseInjectSignalFields)
```

### Option 3: Use Case Expression
Instead of if-then-else, try case with decidable equality:
```agda
routeCommand cmdType with cmdType ≟ "Echo"
... | yes _ = Echo <$> keyValue "message"
... | no _  with cmdType ≟ "ParseDBC"
...   | yes _ = ParseDBC <$> multilineValue "yaml"
-- etc.
```

## Testing Commands

Once routing is fixed, test all 4 commands:

```bash
# Echo (working):
printf 'command: "Echo"\nmessage: "test"' | ./build/aletheia

# ParseDBC (working):
cat examples/sample.dbc.yaml | sed '1s/^/command: "ParseDBC"\nyaml: /' | ./build/aletheia

# ExtractSignal (to test):
# Create test file with: command, message, signal, frame, dbc_yaml
# Field order matters: dbc_yaml must be LAST (consumes to EOF)

# InjectSignal (to test):
# Create test file with: command, message, signal, value, frame, dbc_yaml
# Field order matters: dbc_yaml must be LAST (consumes to EOF)
```

## Build Commands

```bash
# Type-check single module:
cd src && agda +RTS -N32 -RTS Aletheia/Protocol/Parser.agda

# Full build:
cabal run shake -- build

# Haskell only (if Agda unchanged):
cabal run shake -- build-haskell
```

## Current Commit Status

Last commit: `9ed66b1` - WIP: Protocol parser with known routing issue
- All 4 critical fixes complete ✅
- Protocol parser structure complete ✅
- Command routing broken ❌

## After Fixing Routing

1. Test all 4 commands end-to-end
2. Commit working parser
3. Create Python wrapper (`python/aletheia/client.py`)
4. Integration tests
5. **MANDATORY**: Architectural constraint review (1-2 days)
   - CAN-FD evaluation (8-byte vs 64-byte frames)
   - Extended CAN IDs (11-bit vs 29-bit)
   - Signal multiplexing prevalence
   - Decision: refactor NOW vs LATER

## Files to Read on Resume

- `src/Aletheia/Protocol/Parser.agda` - The broken routing logic
- `src/Aletheia/Protocol/Handlers.agda` - The handlers that should be called
- `src/Aletheia/Main.agda` - The dispatcher (handleCommand function)
- `.phase1-progress-review.md` - Full progress analysis
- `PHASE1_AUDIT.md` - All constraints and limitations

## Estimated Time to Fix

- Debug routing: 30min - 2 hours
- Test all commands: 30min
- Then ready for Python wrapper (1-2 days)

## Key Learning

The stdlib `Data.String.Properties._==_` compiles but doesn't work correctly in the routing context. Need to investigate why or use alternative approach (explicit parsers per command type, or case analysis with Dec).
