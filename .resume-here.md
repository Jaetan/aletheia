# ðŸš€ RESUME HERE - Quick Start Guide

**Status**: Phase 1 at 95% - ONE bug away from completion!

## The Bug (30min-2hr fix)

**Location**: `src/Aletheia/Protocol/Parser.agda:125-160`

**What's broken**: Command routing - all commands go to Echo handler

**Test it**:
```bash
# This SHOULD fail (missing fields) but returns Echo success:
printf 'command: "ExtractSignal"\nmessage: "test"' | ./build/aletheia
```

**Why it matters**: Blocks testing of ExtractSignal and InjectSignal commands

## Three Debug Options (pick one)

### Option A: Quick Debug (10min)
Add temporary debug output to see what string is parsed:
```agda
-- In parseCommand, temporarily change:
parseCommand : Parser String  -- Return String instead of Command
parseCommand = parseCommandType <* newline
-- Build, test, see what string we actually get
```

### Option B: Explicit Parsers (30min)
Replace routing with explicit command parsers:
```agda
parseCommand : Parser Command
parseCommand =
  (string "command: \"Echo\"" *> ... )
  <|> (string "command: \"ParseDBC\"" *> ... )
  <|> (string "command: \"ExtractSignal\"" *> ... )
  <|> (string "command: \"InjectSignal\"" *> ... )
```

### Option C: Case Analysis (45min)  
Replace if-then-else with case/with patterns:
```agda
routeCommand cmdType with cmdType â‰Ÿ "Echo"
... | yes _ = Echo <$> keyValue "message"
... | no _ with cmdType â‰Ÿ "ParseDBC"
-- etc.
```

## After Fix (rest of Phase 1)

1. **Test all 4 commands** (30min)
   - Echo âœ… (already works)
   - ParseDBC âœ… (already works)
   - ExtractSignal (needs field order: message, signal, frame, dbc_yaml)
   - InjectSignal (needs field order: message, signal, value, frame, dbc_yaml)

2. **Python wrapper** (1-2 days)
   - `python/aletheia/client.py`
   - CANDecoder class with subprocess interface

3. **Integration tests** (0.5 day)
   - Python â†” binary round-trip
   - Real DBC file from OpenDBC

4. **MANDATORY: Architectural review** (1-2 days)
   - CAN-FD? Extended IDs? Multiplexing?
   - Decision: Refactor NOW or accept constraints?

## Build Commands

```bash
# Type-check parser:
cd src && agda +RTS -N32 -RTS Aletheia/Protocol/Parser.agda

# Full rebuild:
cabal run shake -- build  # ~11s

# Haskell only:
cabal run shake -- build-haskell  # ~3s
```

## What's Already Done âœ…

All 4 critical fixes complete with **ZERO postulates**:
1. âœ… Rational parser: "0.25" â†’ 1/4
2. âœ… Signal scaling: proper division with factor
3. âœ… Response formatting: â„š and bytes to strings
4. âœ… Byte array parser: hex strings to Vec Byte 8

Build pipeline working. Echo and ParseDBC tested end-to-end.

## More Context

- `.next-session-notes.md` - Detailed debugging steps
- `.phase1-progress-review.md` - Full progress analysis  
- `PHASE1_AUDIT.md` - All constraints and limitations
- `CLAUDE.md` - Complete project context

## Estimated Time

- Fix routing: 30min - 2 hours
- Complete Phase 1: 2-4 days total
- Then Phase 2 (LTL reasoning)

**You're almost there!** ðŸŽ¯
