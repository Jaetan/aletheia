# Session State: Performance Optimization — Path to 8,000 fps

**Branch:** `main`
**Last Updated:** 2026-02-06
**Status:** Steps 1-3 COMPLETE. Step 4 (Binary protocol) is optional.

---

## Decision: 4-Step Optimization Plan

Target ~8,000 fps (125 us/frame) for 1 Mbps CAN bus. **ACHIEVED: 9,229 fps (108 us/frame).**

| Step | What | Projected fps | Status |
|------|------|--------------|--------|
| 1 | GHC compiler flags | ~3,800 | ✅ Done (no e2e change — IPC bound) |
| 2 | Eliminate remaining Fin types | ~4,500 | ✅ Done (no e2e change — IPC bound) |
| 3 | **Shared library via FFI (eliminate IPC)** | **~7,500-8,000** | **✅ Done — 9,229 fps (2.88x speedup)** |
| 4 | Binary protocol for data frames | ~11,000-12,500 | Optional |

---

## Completed: Step 3 — Shared Library FFI

Replaced subprocess IPC with direct FFI calls via ctypes → libaletheia-ffi.so.

### What was done
- Created `AletheiaFFI.hs`: Haskell FFI wrapper with `foreign export ccall`
- Added `foreign-library aletheia-ffi` stanza to `aletheia.cabal`
- **Merged FFI into `AletheiaClient`** — single unified client, no subprocess
- Removed `BinaryClient`, `binary_utils.py`, `ffi_client.py`
- GHC RTS lifecycle: ref-counted `hs_init()`, never calls `hs_exit()` (reuse safe)
- 120 tests pass in 0.18s (was 1.37s with subprocess)

### Performance Results

| Benchmark | Before (IPC) | After (FFI) | Speedup |
|-----------|-------------|-------------|---------|
| Streaming LTL (3 props) | 3,199 fps | **9,229 fps** | **2.88x** |
| Signal Extraction | 2,887 fps | 8,184 fps | 2.83x |
| Frame Building | — | 5,868 fps | — |
| Per-frame latency | 314 us | **108 us** | 2.9x |

### Key Architecture Change
- `AletheiaClient` now uses `ctypes.CDLL` directly (no subprocess)
- `_send_command()` calls `aletheia_process()` via FFI
- State managed via `StablePtr (IORef StreamState)` on Haskell side
- GHC RTS initialized once per process, ref-counted for multiple clients

---

## Completed: Steps 0-2 (see plan file for details)

- Step 0: Byte = ℕ (+33%, 2,500 → 3,300 fps)
- Step 1: GHC compiler flags (no e2e change, IPC bound)
- Step 2: Fin elimination (no e2e change, IPC bound; now shows in FFI path)

---

## Phase 3 — COMPLETE

All 6 goals delivered:
1. ✅ Parser soundness proofs
2. ✅ LTL semantics proofs (all 12 operators)
3. ✅ CAN encoding proofs
4. ✅ DSL translation proofs
5. ✅ Three-valued signal semantics
6. ✅ Performance optimization — 9,229 fps (target was 8,000 fps)

---

## Development Environment

- **Agda binary**: `/home/nicolas/.cabal/bin/agda`
- **Shell**: `/usr/bin/fish`
- **Python venv**: `source venv/bin/activate` (in project root)
- **Build**: `cabal run shake -- build` (produces `build/libaletheia-ffi.so`)
- **Tests**: `cd python && python3 -m pytest tests/ -v`
