# Session State: CAN Encoding/Decoding Proofs

**Branch:** `main`
**Last Updated:** 2026-01-27
**Status:** **BATCH PROOFS COMPLETE** - `injectAll-preserves-disjoint` type-checks

---

## Proof Architecture (5 Layers) - ALL COMPLETE

```
Layer 4: Composition (signal-level)      ✅ COMPLETE
Layer 3: Scaling (ℤ ↔ ℚ)                 ✅ COMPLETE (both directions)
Layer 2: Integer conversion (ℕ ↔ ℤ)      ✅ COMPLETE
Layer 1: Bit operations (BitVec ↔ bytes) ✅ COMPLETE
Layer 0: BitVec primitives (structural)  ✅ COMPLETE
```

---

## Complete Proofs

| Layer | Proof | File | Description |
|-------|-------|------|-------------|
| 0 | `testBit-setBit-same/diff` | BitVec | Structural bit independence |
| 0 | `setBit-setBit-comm` | BitVec | Disjoint setBit commutes |
| 1 | `extractBits-injectBits-roundtrip` | Endianness | Bit extraction roundtrip |
| 1 | `injectBits-preserves-disjoint` | Endianness | Disjoint ranges preserved |
| 1 | `injectBits-commute` | Endianness | Disjoint bit injections commute |
| 2 | `fromSigned-toSigned-roundtrip` | Encoding | ℕ → ℤ → ℕ |
| 2 | `toSigned-fromSigned-roundtrip` | Encoding | ℤ → ℕ → ℤ |
| 3 | `removeScaling-applyScaling-exact` | Encoding | ℤ → ℚ → ℤ (exact) |
| 3 | `applyScaling-removeScaling-bounded` | Encoding | ℚ → ℤ → ℚ (bounded) |
| 4 | `extractSignal-injectSignal-roundtrip-*` | Encoding.Properties | Full roundtrip |
| **Core** | **`injectSignal-preserves-disjoint-bits`** | **Encoding** | **When injectSignal succeeds, bits at disjoint positions preserved** |
| **Signal** | **`single-inject-preserves-same-bo`** | **Batch/Properties** | **Single injection preserves disjoint extraction** |
| **Batch** | **`injectAll-preserves-disjoint`** | **Batch/Properties** | **Batch injection preserves disjoint extraction** |

---

## Completed This Session

### Proof Chain Complete

```
injectSignal-preserves-disjoint-bits (Encoding.agda)
         ↓ (bits preserved)
    extractSignal-bits-eq (Batch/Properties.agda)
         ↓ (equal bits → equal extractSignal)
single-inject-preserves-same-bo (Batch/Properties.agda)
         ↓ (induction step)
 injectAll-preserves-disjoint (Batch/Properties.agda)
```

### Key Lemmas

1. **`injectSignal-preserves-disjoint-bits`** (Encoding.agda:199-258)
   - When `injectSignal` succeeds, bits at disjoint positions are unchanged
   - Uses plain `with`-patterns (no `rewrite`, no `in`) to mirror `injectSignal`'s structure
   - Core proof extracts `frame' ≡ expectedFrame` via `just-injective (sym eq)`

2. **`extractSignal-bits-eq`** (Batch/Properties.agda:255-289)
   - If extracted bits are equal, `extractSignal` returns equal results
   - Chains: bits → core → scaled value → bounds check → result

3. **`single-inject-preserves-same-bo`** (Batch/Properties.agda:291-319)
   - Simplified to use `injectSignal-preserves-disjoint-bits` from Encoding.agda
   - Only 28 lines (vs ~70 lines of duplicated proof before)

---

## Files Modified This Session

- **`src/Aletheia/CAN/Encoding.agda`**
  - Added `injectSignal-preserves-disjoint-bits` - key structural lemma
  - Added `extractionBytes≡payloadIso` helper
  - Added `just-injective` helper (private)
  - Added imports: `_≤_`, `case_of_`, `cong`, `sym`, `trans`

- **`src/Aletheia/CAN/Batch/Properties.agda`**
  - Removed duplicate `extractionBytes≡payloadIso` (now imported from Encoding)
  - Simplified `single-inject-preserves-same-bo` to use imported lemma
  - All proofs type-check

- **`CLAUDE.md`**
  - Added Development Environment section with Agda path and shell info

---

## Key Insights

> "Use plain with-patterns, avoid rewrite and in"

For proving lemmas about functions with nested `with`:
- Mirror the function's structure exactly with matching `with` patterns
- Don't use `rewrite` or `in` patterns - they interact badly with `with`
- Extract the core proof logic into a helper that takes the derived equality

> "Keep only one proof"

The proof architecture should have:
- **One fundamental lemma** at the right abstraction level (`injectSignal-preserves-disjoint-bits`)
- **Lifting functions** that use it (`extractSignal-bits-eq`, `single-inject-preserves-same-bo`)
- **No duplication** - each proof fact should be stated and proven once

---

## Development Environment

- **Agda binary**: `/home/nicolas/.cabal/bin/agda`
- **Shell**: `/usr/bin/fish`
- **Shell config**: Source `/home/nicolas/.config/fish/config.fish`
- **User binaries**: `/home/nicolas/.local/bin`
- **User libraries**: `/home/nicolas/.local/lib`

**Type-checking command**:
```bash
/home/nicolas/.cabal/bin/agda +RTS -N32 -RTS /home/nicolas/dev/agda/aletheia/src/Aletheia/CAN/Batch/Properties.agda
```

---

## Next Tasks

1. **Update PROJECT_STATUS.md**
   - Mark Phase 2B.1 batch operation proofs as complete

2. **Consider further cleanup**
   - The `extractSignal-bits-eq` helper could potentially move to Encoding.agda
   - Document the proof architecture in comments
