# Session State: Position Tracking in Progress

**Date**: 2025-01-19
**Last Commit**: f5c220e "Add position tracking to parser combinators for precise error reporting"
**Status**: ðŸ”„ Position tracking - Core combinators done, need to update client parsers

## What We Accomplished This Session

### âœ… Parser Combinators with Position Tracking

**Motivation**: Give users exact error locations (line 5, column 12) instead of generic "parse failed"

**Implementation** (src/Aletheia/Parser/Combinators.agda):

1. **Position Type**:
   ```agda
   record Position : Set where
     constructor mkPos
     field
       line : â„•
       column : â„•
   ```

2. **Position Advancement**:
   - `advancePosition : Position â†’ Char â†’ Position`
     - Normal chars: increment column
     - Newline '\n': increment line, reset column to 1
   - `advancePositions : Position â†’ List Char â†’ Position`
     - Bulk advancement for efficiency

3. **Parser Type Refactor**:
   - **Old**: `Parser A = List Char â†’ Maybe (A Ã— List Char)`
   - **New**: `Parser A = Position â†’ List Char â†’ Maybe (ParseResult A)`
   - `ParseResult` contains: value, position, remaining input

4. **Updated All Combinators**:
   - âœ… Basic: pure, fail, >>=, <$>, <*>, *>, <*, <|>
   - âœ… Characters: satisfy, char, anyChar, oneOf, noneOf  
   - âœ… Repetition: many, some, count, countRange
   - âœ… Strings: string
   - âœ… Utilities: runParser, runParserWithPos, runParserPartial
   - âœ… Indentation: exactSpaces, countLeadingSpaces, atIndent

5. **Backward Compatibility**:
   - `runParser` maintains old interface (discards position)
   - `runParserWithPos` returns (value, position) for error reporting

## Next Steps (In Order)

### 1. Update DBC Parser (src/Aletheia/DBC/Parser.agda)

**What needs updating**:
- All custom parsers that called combinators directly
- Signature changes due to new Parser type
- Should be mostly mechanical (combinators handle position automatically)

**Estimated effort**: 30-60 minutes

### 2. Update DSL Parser with Position-Aware Errors

**What to change** (src/Aletheia/LTL/DSL/Parser.agda):
```agda
-- Current ParseError
data ParseError : Set where
  SyntaxError : String â†’ ParseError
  FuelExhausted : â„• â†’ â„• â†’ ParseError

-- New ParseError with position
data ParseError : Set where
  SyntaxError : String â†’ Position â†’ ParseError  -- Add position!
  FuelExhausted : â„• â†’ â„• â†’ ParseError
```

**Update error messages**:
```agda
formatError : ParseError â†’ String
formatError (SyntaxError msg pos) =
  "Parse error at line " ++ show (line pos) ++ ", column " ++ show (column pos) ++
  ": " ++ msg
formatError (FuelExhausted actual limit) = ...
```

**How to get position on failure**:
When `runParser parsePropertyYaml` returns `nothing`, we don't directly know where it failed. Options:

a) **Modify parser to track furthest position** (most accurate):
   ```agda
   parseProperyWithTracking : String â†’ Either (String Ã— Position) PythonLTL
   -- Track furthest position reached before failure
   ```

b) **Use runParserWithPos and check** (simpler):
   ```agda
   case runParserWithPos parsePropertyYaml input of
     nothing â†’ "Syntax error (position unknown)"
     just (result, pos) â†’ success
   ```

c) **Add failure position to Parser type** (most comprehensive but bigger change)

**Estimated effort**: 1-2 hours

### 3. Test Error Messages

Create test cases with intentional syntax errors:
```yaml
# Missing colon
type always
formula:
  type: compare
```

Expected output:
```
Parse error at line 1, column 13: Expected ':' after key 'type'
```

## Technical Notes

### Position Tracking is Free

- Position updates are just bookkeeping (incrementing numbers)
- No impact on termination checking
- Minimal runtime overhead
- Compilation time unchanged: still ~20s

### Parser Combinator Changes Are Transparent

Client parsers don't need to manually track position:
```agda
-- This automatically tracks position!
parseCompare = 
  identifier >>= Î» sig â†’  -- Position advanced by identifier length
  spaces *>               -- Position advanced by whitespace
  char '=' >>= Î» _ â†’      -- Position advanced by 1
  rational                -- Position advanced by number length
```

### Backward Compatibility

Old code using `runParser` still works:
```agda
runParser myParser input  -- Returns Maybe A (position discarded)
```

New code can get positions:
```agda
runParserWithPos myParser input  -- Returns Maybe (A Ã— Position)
```

## Files Modified

```
src/Aletheia/Parser/Combinators.agda  - Full position tracking (89 insertions, 42 deletions)
```

## Known Issues / TODOs

1. **DBC Parser** - Needs update for new Parser signature
2. **DSL Parser** - Needs to use position in error messages
3. **Protocol Parser** - Might need updating too
4. **Test suite** - Add tests for position accuracy
5. **Documentation** - Update parser docs with position info

## Session Continuation

When resuming:
```bash
cd /home/nicolas/dev/agda/aletheia
cat .session-state.md
git log --oneline -3

# Verify combinators still work
cd src && agda +RTS -N32 -RTS Aletheia/Parser/Combinators.agda

# Start updating DBC parser
vim src/Aletheia/DBC/Parser.agda
```

**Current task**: Update DBC parser for new Parser signature
**Next task**: Add position to DSL error messages
**Final task**: Test end-to-end error reporting

## Previous Session Work

- âœ… Implemented schema-specific YAML types
- âœ… Created PropertyYaml â†’ PythonLTL converter
- âœ… Implemented fuel-bounded parser (fuel=100, 19s compile, 1.4GB memory)
- âœ… Added depth function for verification
- âœ… Basic error reporting (syntax vs fuel exhaustion)

See commit 8a20fb5 for details.
