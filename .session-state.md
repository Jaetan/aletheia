# Session State: Phase 4 — Production Hardening

**Branch:** `main`
**Last Updated:** 2026-02-06
**Status:** Phase 4 in progress. UX research complete. Ready to implement.
**Next session:** Start with Goal 1 — implement `python/aletheia/checks.py` (Check API).

---

## Phase 4 Goals

Implementation order (dependency-driven):

| Order | # | Goal | Status | Rationale |
|-------|---|------|--------|-----------|
| 1st | 1 | Check API (`checks.py`) | Not started | Foundation — YAML and Excel compile through it |
| 2nd | 2 | YAML loader (`yaml_loader.py`) | Not started | Declarative layer above Check API |
| 3rd | 3 | Excel loader (`excel_loader.py`) | Not started | Highest-level tier, uses Check API |
| 4th | 5 | CAN log reader (`readers.py`) | Not started | CLI needs this to read log files |
| 5th | 4 | CLI tool (`python -m aletheia`) | Not started | Ties everything together |
| 6th | 6 | Richer violation diagnostics | Not started | Improves output of all tiers |
| 7th | 7 | Deployment guide (`docs/DEPLOYMENT.md`) | Not started | Documents production use |
| 8th | 8 | Tutorial / cookbook (`docs/TUTORIAL.md`) | Not started | Documents all tiers end-to-end |

---

## Design: Four-Tier Interface

All tiers compile to the same verified `Property` objects.

| Tier | User | Interface |
|------|------|-----------|
| Excel | Technician | Fill in numbers in .xlsx template, press Run |
| YAML | Test engineer | Edit config files, version-control, CI/CD |
| Check API | Scripter | `Check.signal("Speed").never_exceeds(220)` |
| DSL | Developer | `Signal("Speed").less_than(220).always()` |

### Excel Templates

**DBC sheet** (one row per signal):
| Message ID | Message Name | DLC | Signal | Start Bit | Length | Byte Order | Signed | Factor | Offset | Min | Max | Unit |

**Checks sheet** (one row per check):
| Check Name | Signal | Condition | Value | Min | Max | Time (ms) | Severity |

**When/Then sheet** (one row per response-time check):
| Check Name | When Signal | When Condition | When Value | Then Signal | Then Condition | Then Value | Within (ms) | Severity |

### YAML Schema
```yaml
checks:
  - name: "Speed limit"
    signal: VehicleSpeed
    condition: never_exceeds
    limit: 220
    severity: critical
  - name: "Brake response"
    when: { signal: BrakePedal, condition: exceeds, value: 50 }
    then: { signal: BrakeLight, condition: equals, value: 1 }
    within_ms: 100
    severity: safety
```

### Check API Vocabulary
| Method | Compiles to |
|--------|------------|
| `never_exceeds(v)` | `Signal(s).less_than(v).always()` |
| `never_below(v)` | `Signal(s).greater_than_or_equal(v).always()` |
| `stays_between(lo, hi)` | `Signal(s).between(lo, hi).always()` |
| `never_equals(v)` | `Signal(s).equals(v).never()` |
| `when(...).then(...).within(ms)` | `p.implies(q.within(ms)).always()` |
| `settles_between(lo, hi).within(ms)` | `Signal(s).between(lo, hi).for_at_least(ms)` |
| `stable_for(ms)` | `Signal(s)....for_at_least(ms)` |

---

## v0.3.2 Released

Includes all Phase 3 work plus:
- Fin→ℕ elimination on all hot-path types
- Shared-library FFI (9,229 fps, eliminated subprocess IPC)
- sysinfo.py benchmark for Docker sizing
- Demo scripts mention offline + online validation
- Architecture cleanup (removed dead code, old integration tests)

---

## Development Environment

- **Agda binary**: `/home/nicolas/.cabal/bin/agda`
- **Shell**: `/usr/bin/fish`
- **Python venv**: `source venv/bin/activate` (in project root)
- **Build**: `cabal run shake -- build` (produces `build/libaletheia-ffi.so`)
- **Tests**: `cd python && python3 -m pytest tests/ -v`
