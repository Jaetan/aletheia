# Session State: Phase 4 — Production Hardening + Install Target

**Branch:** `main`
**Last Updated:** 2026-02-08
**Status:** Phase 4 Goals 1-3 complete. Install/uninstall target partially implemented.
**Next session:** Finish install target implementation, then Goal 5 (CAN log reader) or Goal 4 (CLI tool).

---

## In-Progress: Install/Uninstall Shake Targets

**Plan file:** `/home/nicolas/.claude/plans/twinkly-conjuring-pebble.md`

### What's Done

| File | Status | Notes |
|------|--------|-------|
| `.gitignore` | ✅ Done | Added `python/aletheia/_install_config.py` |
| `python/aletheia/client.py` | ✅ Done | Added `_install_config` import at top of `_find_ffi_library()`, updated docstring, fixed stale error msg |
| `Shakefile.hs` | ✅ Done (needs testing) | Added imports, `getGhcDeps`, `checkPrerequisites`, `phony "install"`, `phony "uninstall"` |
| `docs/development/BUILDING.md` | ❌ Not started | Need to add System Installation section, Docker example, update Common Build Commands |

### What Needs to Be Done Next Session

1. **Update BUILDING.md** — Add "System Installation (Optional)" section with:
   - Prerequisites (patchelf)
   - Install/uninstall commands with PREFIX and CONFIGURE_SHELL
   - Directory layout diagram
   - Docker multi-stage build example
   - Add install/uninstall to Common Build Commands section

2. **Test the install target** — Run `cabal run shake -- install` to verify:
   - Shakefile.hs compiles (new imports + helpers)
   - Library bundling works (ldd parsing, cp -L)
   - patchelf RUNPATH patching works
   - Python venv creation + pip install works
   - `_install_config.py` is written correctly
   - The installed venv can `from aletheia import AletheiaClient`
   - Uninstall cleans up properly

3. **Possible edge cases to check:**
   - `doesFileExist` in Shake's `Action` monad vs `System.Directory.doesFileExist` in `liftIO`
     (the Shakefile uses `doesFileExist` unqualified — check it's the `liftIO`-free Shake version
     for the MAlonzo rule and `liftIO $ doesFileExist` for the install target)
   - The `shareAletheiaDir` cleanup in uninstall may be redundant if manifest already lists it

### Key Design Decisions

- `getGhcDeps` uses `ldd` + filters for GHC lib path prefix
- `_install_config.py` generated into site-packages (not source tree)
- `manifest.txt` lists 3 directories for clean uninstall
- Shell alias uses marker `# Added by aletheia install` for idempotency
- `CONFIGURE_SHELL=1` is opt-in (not default)

---

## Phase 4 Goals

Implementation order (dependency-driven):

| Order | # | Goal | Status | Notes |
|-------|---|------|--------|-------|
| 1st | 1 | Check API (`checks.py`) | ✅ Complete | 6 simple + 3 when/then conditions |
| 2nd | 2 | YAML loader (`yaml_loader.py`) | ✅ Complete | File + inline string loading |
| 3rd | 3 | Excel loader (`excel_loader.py`) | ✅ Complete | DBC + checks + template creation |
| 4th | 5 | CAN log reader (`readers.py`) | Not started | CLI needs this to read log files |
| 5th | 4 | CLI tool (`python -m aletheia`) | Not started | Ties everything together |
| 6th | 6 | Richer violation diagnostics | Not started | Improves output of all tiers |
| 7th | 7 | Deployment guide (`docs/DEPLOYMENT.md`) | Not started | Documents production use |
| 8th | 8 | Tutorial / cookbook (`docs/TUTORIAL.md`) | Not started | Documents all tiers end-to-end |

### Completed Deliverables (Goals 1-3)

**Code:**
- `python/aletheia/checks.py` — Check API with `CheckResult`, `CheckSignal`, `WhenSignal`, `ThenSignal`
- `python/aletheia/yaml_loader.py` — `load_checks()` from file path or YAML string
- `python/aletheia/excel_loader.py` — `load_checks_from_excel()`, `load_dbc_from_excel()`, `create_template()`
- `python/stubs/openpyxl/` — Type stubs for basedpyright strict mode
- `python/aletheia/__init__.py` — Exports all three modules
- `python/pyproject.toml` — Added openpyxl>=3.1 dependency

**Tests (228 total, all passing):**
- `tests/test_checks.py` — Check API unit tests
- `tests/test_yaml_loader.py` — YAML loader unit tests
- `tests/test_excel_loader.py` — Excel loader unit tests (49 tests)

**Documentation:**
- `docs/development/INTERFACES.md` — Interface Guide (Check API, YAML, Excel end-to-end)
- `docs/development/PYTHON_API.md` — Fixed 6 violation detection bugs, added missing methods
- `docs/INDEX.md` — Updated navigation
- `README.md` — Added Higher-Level Interfaces section
- `python/README.md` — Updated links

**Demos:**
- `examples/demo/demo_check_api.py` — Check API showcase
- `examples/demo/demo_yaml_loader.py` — YAML loader demo
- `examples/demo/demo_excel_loader.py` — Excel loader demo
- `examples/demo/demo_all_interfaces.py` — Four-tier equivalence proof
- `examples/demo/demo_checks.yaml` — YAML data file

---

## Development Environment

- **Agda binary**: `/home/nicolas/.cabal/bin/agda`
- **Shell**: `/usr/bin/fish`
- **Python venv**: `source .venv/bin/activate.fish` (in project root — note `.venv/` not `venv/`)
- **Build**: `cabal run shake -- build` (produces `build/libaletheia-ffi.so`)
- **Tests**: `cd python && python3 -m pytest tests/ -v`
