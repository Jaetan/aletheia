# Claude Code Session Notes

**Last Updated**: 2025-11-10
**Git Tag**: phase_1_parsers (commit 077b39d)

## Session Summary

This session focused on completing and optimizing the parser combinators library portion of Phase 1 (Core Infrastructure).

### Completed Work

1. **Created CLAUDE.md** - Comprehensive development guide including:
   - Build system commands (Shake via Cabal)
   - Three-layer architecture (Agda → Haskell → Python)
   - Module structure and development workflows
   - Performance optimization tips
   - Troubleshooting guidance

2. **Optimized Parser Combinators** (`src/Aletheia/Parser/Combinators.agda`):
   - **Problem**: Type-checking took 60+ seconds, causing timeouts
   - **Root Cause**: Expensive symbolic evaluation from:
     - Nested `with` patterns in character class functions
     - Fuel-based recursion (`defaultFuel = 1000`)
     - String conversion in helper functions

   - **Solutions Applied**:
     - Pre-computed character codes as constants (e.g., `code-0 = 48`)
     - Refactored `parse`/`parsePartial` → `runParser`/`runParserPartial`
     - Work on `List Char` instead of `String` to avoid conversion overhead
     - Use simple pattern matching helper (`checkComplete`) instead of `with`
     - Added `--without-K` flag for consistency

   - **Results**: Type-checking now ~2 seconds (was 60s+ timeout)

3. **Created PrecompileStdlib.agda** - Caches common stdlib imports (~20s one-time cost)

4. **Created Parser/Examples.agda** - Working examples with proofs:
   - Identifier parsing
   - Number parsing
   - Whitespace handling
   - Parentheses parsing
   - All examples include `refl` proofs that type-check successfully

5. **Updated .gitignore** - Added `*.log` and `c.log` patterns

### Key Technical Insights

- **GHC RTS Options**: Use `agda +RTS -N8 -RTS` to parallelize type-checking (Agda is compiled with GHC)
- **`with` patterns are expensive**: Avoid them on complex parser compositions in type signatures
- **Fuel-based recursion**: Causes symbolic evaluation issues during type-checking
- **String vs List Char**: Keep parsers working on `List Char` internally, convert at boundaries only

### Current State of Codebase

**Completed Modules** (all type-check quickly):
- `src/Aletheia/Parser/Combinators.agda` (~2s)
- `src/Aletheia/Parser/Properties.agda` (~1s, placeholder for future proofs)
- `src/Aletheia/Parser/Examples.agda` (~3s with proof checking)
- `src/PrecompileStdlib.agda` (stdlib cache)

**Build System**:
- Shake-based build via Cabal
- Agda → MAlonzo → Haskell binary
- Python wrapper via subprocess

**Module Flags**: All use `--safe --without-K --no-main`

### Next Steps (Phase 1 Continuation)

According to DESIGN.md Phase 1, remaining work:
1. ~~Parser combinators library~~ ✓ **COMPLETED**
2. **CAN frame types** (`src/Aletheia/CAN/Frame.agda`)
   - Define CAN frame structure
   - Signal types and encoding
3. **Basic CAN encoding/decoding** (`src/Aletheia/CAN/Encoding.agda`)
4. **Simple DBC parser** (`src/Aletheia/DBC/Parser.agda`)
   - Parse DBC YAML format
   - Map to internal types
5. Verify existing **Haskell shim** works with compiled code
6. Test **Python wrapper** integration

### Development Tips for Next Session

**Type-checking Commands**:
```bash
cd /home/nicolas/dev/agda/aletheia/src
agda +RTS -N8 -RTS Aletheia/YourModule.agda
```

**Build Commands**:
```bash
cd /home/nicolas/dev/agda/aletheia
cabal run shake -- build          # Full build
cabal run shake -- build-agda     # Agda only
cabal run shake -- clean          # Clean build
```

**Common Issues**:
- If type-checking is slow, check for `with` patterns or String operations in type signatures
- Use `PrecompileStdlib.agda` approach for new common imports
- Remember GHC RTS flags: `+RTS -N8 -RTS`

### Files Modified This Session

- `CLAUDE.md` (new) - Development guide
- `src/Aletheia/Parser/Combinators.agda` (optimized)
- `src/Aletheia/Parser/Examples.agda` (new) - Working examples
- `src/PrecompileStdlib.agda` (new) - Stdlib cache
- `.gitignore` (updated) - Added log patterns

### Recommended Starting Point for Next Session

Start with **CAN frame types** (`src/Aletheia/CAN/Frame.agda`):
1. Read existing stub to understand current state
2. Define core CAN frame data types
3. Add basic properties and proofs
4. Ensure fast type-checking using lessons learned from parser combinators

Refer to CLAUDE.md for architecture and development workflow guidance.
